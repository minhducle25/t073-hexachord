import React, { useRef, useEffect, useImperativeHandle } from 'react';
import * as Tone from 'tone';

const ToneGenerator = React.forwardRef((props, ref) => {
  const synthRef = useRef(null);

  useEffect(() => {
    synthRef.current = new Tone.Synth().toDestination();
    return () => {
      synthRef.current.dispose();
    };
  }, []);

  useImperativeHandle(ref, () => ({
    playNoteWithY: async (note, y) => {
      await Tone.start(); // Ensure Tone.js is started
      let octave;

      // Replace Unicode sharp symbol with standard sharp symbol
      const standardizedNote = note.replace('â™¯', '#');

      if (['C', 'C#', 'D', 'D#'].includes(standardizedNote)) {
        if (y <= 25) {
          octave = 6;
        } else if (y <= 100) {
          octave = 5;
        } else if (y <= 175) {
          octave = 4;
        } else {
          octave = 3;
        }
      } else {
        if (y <= 75) {
          octave = 5;
        } else if (y < 175) {
          octave = 4;
        } else if (y <= 249) {
          octave = 3;
        } else {
          octave = 2;
        }
      }

      const noteWithOctave = `${standardizedNote}${octave}`;
      console.log(`Playing note: ${noteWithOctave}, Y: ${y}`);

      try {
        const midiNumber = Tone.Frequency(noteWithOctave).toMidi(); // Convert note and octave to MIDI number
        console.log(`MIDI number: ${midiNumber}`);
        const frequency = Tone.Frequency(midiNumber, "midi").toFrequency(); // Convert MIDI number to frequency
        console.log(`Frequency: ${frequency}`);
        synthRef.current.triggerAttackRelease(frequency, "8n");
      } catch (error) {
        console.error(`Error playing note: ${noteWithOctave}`, error);
      }
    }
  }));

  return null; // No need to render anything
});

export default ToneGenerator;